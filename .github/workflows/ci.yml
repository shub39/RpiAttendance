name: Build Server

on:
  push:
    branches:
      - master
  workflow_dispatch: { }

permissions:
  contents: write

jobs:
  build-android:
    if: startsWith(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          cache: 'gradle'

      - name: Cook KeyStore
        run: echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > $GITHUB_WORKSPACE/signing-key.jks

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build with Gradle
        run: |
          ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/signing-key.jks \
          -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=key0 \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}
          
          APK_PATH=$(find androidApp/build/outputs/ -name "*.apk" -print -quit)
          
          if [ -z "$APK_PATH" ]; then
            echo "::error::Could not find APK file."
            exit 1
          fi
          
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: androidApp/build/outputs/**/*.apk

  build-server:
    if: startsWith(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: 'gradle'

      - name: Install AArch64 Cross-Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Patch libgcc path for CI
        run: |
          LIBGCC_PATH=$(aarch64-linux-gnu-gcc -print-libgcc-file-name)
          sed -i "s|/usr/lib/gcc/aarch64-linux-gnu/15.1.0/libgcc.a|$LIBGCC_PATH|g" server/build.gradle.kts

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Arm64 Executable
        run: ./gradlew :server:linkReleaseExecutableLinuxArm64
        env:
          KONAN_DATA_DIR: ${{ github.workspace }}/.konan

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-linux-arm64
          path: server/build/bin/linuxArm64/releaseExecutable/server.kexe

  create-release:
    if: startsWith(github.event.head_commit.message, '[release]')
    needs: [ build-android, build-server ]
    runs-on: ubuntu-latest
    steps:
      - name: Download Server
        uses: actions/download-artifact@v4
        with:
          name: server-linux-arm64

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: app-release.apk

      - name: Extract App Version Name from Gradle
        run: |
          GRADLE_FILE="androidApp/build.gradle.kts" 
          VERSION_NAME=$(grep -E 'val appVersionName' $GRADLE_FILE | head -n 1 | awk -F'"' '{print $2}')

          if [ -z "$VERSION_NAME" ]; then
            echo "::error::Could not extract version name from $GRADLE_FILE."
            exit 1
          fi

          echo "Extracted Version: $VERSION_NAME"
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      - name: Extract Changelog Notes
        run: |
          VERSION="${{ env.VERSION_NAME }}"
          CHANGELOG_FILE="CHANGELOG.md"
          OUTPUT_FILE="commit.txt"

          sed -n "/## ${VERSION}/, /## [0-9]/p" ${CHANGELOG_FILE} | \
          sed '1d;$d' | \
          grep -v '^# Changelog' > ${OUTPUT_FILE}

          if [ ! -s "${OUTPUT_FILE}" ]; then
            echo "::warning file=${CHANGELOG_FILE}::Could not find changelog for version ${VERSION}. commit.txt will be empty."
          fi

          echo "Changelog extracted to commit.txt"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          make_latest: true
          tag_name: ${{ env.VERSION_NAME }}
          name: ${{ env.VERSION_NAME }}
          body_path: commit.txt
          files: |
            server.kexe
            *.apk